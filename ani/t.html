<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Video Player</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Plyr CSS -->
    <link href="https://cdn.jsdelivr.net/npm/plyr@3.7.2/dist/plyr.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/plyr@3.7.2/dist/plyr.polyfilled.js"></script>
    <!-- Turnstile CAPTCHA -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
        body {
            background-color: #121212;
            color: white;
        }
        .header {
            background-color: #1c1c1c;
            padding: 1rem;
            border-bottom: 2px solid #333;
        }
        .header h1 {
            font-size: 1.75rem;
            font-weight: bold;
            letter-spacing: 2px;
            color: #d5eb34;
        }
        .search-box {
            max-width: 150px;
        }
        .video-container {
            max-width: 100%;
            height: 80vh;
            margin: 0 auto;
            text-align: center;
            padding: 2rem 0;
        }
        #player {
            width: 100%;
            height: 100%;
        }
        .currently-playing {
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 1rem;
        }
        .currently-playing strong {
            color: #d5eb34;
            font-weight: bold;
        }
        .buttons-container {
            margin-top: 1rem;
        }
        .btn-custom {
            background-color: #333;
            color: #d5eb34;
            border: none;
            width: 120px;
            margin: 0.5rem;
        }
        .btn-custom:hover {
            background-color: #444;
            color: #fff;
        }
        .btn-outline-custom {
            border: 2px solid #d5eb34;
            color: #d5eb34;
            width: 120px;
            margin: 0.5rem;
        }
        .btn-outline-custom:hover {
            background-color: #d5eb34;
            color: #121212;
        }
        footer {
            background-color: #1c1c1c;
            text-align: center;
            padding: 1rem;
            margin-top: 2rem;
        }
        #timer {
            font-size: 1.5rem;
            color: #fff;
            margin-top: 1rem;
        }
        #turnstile-captcha {
            display: none;
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>

    <!-- Header Section -->
    <header class="header d-flex justify-content-between align-items-center">
        <h1>Ani.MoM</h1>
        <!-- Search form -->
        <form action="/search/" method="get" class="search-box">
            <input type="text" name="q" class="form-control" placeholder="Search..." aria-label="Search" required>
        </form>
    </header>

    <!-- Video Player Section -->
    <div class="container video-container">
        <video id="player" controls>
            <source id="video-source" type="application/x-mpegURL" src="">
        </video>
        <div class="currently-playing">
            <p id="currently-playing-text">Currently Playing: <strong></strong></p>
        </div>

        <div class="buttons-container text-center" id="quality-buttons"></div>

        <div class="d-flex justify-content-center mt-4">
            <button id="previous-button" class="btn btn-outline-custom">Previous</button>
            <button id="next-button" class="btn btn-outline-custom">Next</button>
        </div>

        <div class="d-flex justify-content-center">
            <button id="download-button" class="btn btn-custom">Download This Episode</button>
        </div>

        <div class="text-center" id="timer" style="display: none;">Please Wait - <span id="countdown"></span></div>

        <!-- Turnstile CAPTCHA -->
        <div id="turnstile-captcha" class="turnstile-captcha">
            <div class="cf-turnstile" data-sitekey="0x4AAAAAAA0BQDwqZ-wPx1qa" data-callback="captchaVerified"></div>
        </div>

        <!-- Scrollable episode buttons -->
        <div class="scrollable-episodes" id="episode-buttons-container"></div>
    </div>

    <footer>
        <p class="text-muted">Â© 2024 Ani.MoM. All rights reserved.</p>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Get the 'id' parameter from the URL
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('id').split('-')[0];
        const episodeNumber = urlParams.get('id').split('-')[2];

        const currentlyPlayingText = document.getElementById('currently-playing-text');
        const currentlyPlayingStrong = currentlyPlayingText.querySelector('strong');
        currentlyPlayingStrong.textContent = `${query.charAt(0).toUpperCase() + query.slice(1)} (Episode - ${episodeNumber})`;

        const previousEpisode = parseInt(episodeNumber) - 1;
        const nextEpisode = parseInt(episodeNumber) + 1;
        const previousUrl = `https://anigenix2.blogspot.com/?id=${query}-episode-${previousEpisode}`;
        const nextUrl = `https://anigenix2.blogspot.com/?id=${query}-episode-${nextEpisode}`;

        document.getElementById('previous-button').onclick = function() {
            window.location.href = previousUrl;
        };
        document.getElementById('next-button').onclick = function() {
            window.location.href = nextUrl;
        };

        const downloadButton = document.getElementById('download-button');
        downloadButton.onclick = function() {
            const timerDisplay = document.getElementById('timer');
            const countdownElement = document.getElementById('countdown');
            
            downloadButton.style.display = 'none';
            timerDisplay.style.display = 'block';
            
            let countdown = 3;
            countdownElement.textContent = countdown;
            
            const interval = setInterval(function() {
                countdown -= 1;
                countdownElement.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(interval);
                    // Show CAPTCHA
                    document.getElementById('turnstile-captcha').style.display = 'block';
                }
            }, 1000);
        };

        // Callback for CAPTCHA success
        function captchaVerified(response) {
            if (response) {
                // Redirect to download page if CAPTCHA is passed
                window.location.href = `/dl/?id=${query}-episode-${episodeNumber}`;
            } else {
                alert('CAPTCHA verification failed. Please try again.');
            }
        }

        // Fetch the video URL for the current episode and quality options
        const videoUrlApi = `https://animetize-api.vercel.app/watch/${query}-episode-${episodeNumber}`;
        fetch(videoUrlApi)
            .then(response => response.json())
            .then(data => {
                const videoSource = document.getElementById('video-source');
                const qualityButtonsContainer = document.getElementById('quality-buttons');

                videoSource.src = data.sources.find(source => source.quality === '1080p')?.url || data.sources[0].url;

                data.sources.forEach((source) => {
                    const button = document.createElement('button');
                    button.className = 'btn btn-custom';
                    button.textContent = source.quality;
                    button.onclick = function () {
                        videoSource.src = source.url;
                        const player = new Plyr('#player');
                        player.play();
                    };
                    qualityButtonsContainer.appendChild(button);
                });

                const player = new Plyr('#player');
            })
            .catch(error => console.error('Error fetching video source:', error));

        // Fetch episode list for scrolling buttons
        const episodeListApi = `https://animetize-api.vercel.app/info/${query}`;
        fetch(episodeListApi)
            .then(response => response.json())
            .then(data => {
                const episodeButtonsContainer = document.getElementById('episode-buttons-container');
                data.episodes.forEach(episode => {
                    const episodeButton = document.createElement('button');
                    episodeButton.className = 'episode-button';
                    episodeButton.textContent = `Episode ${episode.number}`;
                    episodeButton.onclick = function() {
                        window.location.href = `https://anigenix2.blogspot.com/?id=${query}-episode-${episode.number}`;
                    };
                    episodeButtonsContainer.appendChild(episodeButton);
                });
            })
            .catch(error => {
                console.error('Error fetching episode list:', error);
            });
    </script>
</body>
</html>
