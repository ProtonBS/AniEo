<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" type="image/x-icon" href="./favicon.ico" />
    <title>AnimeEo VideoPlayer</title>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--𝗣𝗹𝗮𝘂𝘀𝗶𝗯𝗹𝗲-->
    <script defer data-domain="ani.mom" src="https://plausible.io/js/script.js"></script>

    <meta name="google-site-verification" content="-xMMXXGSnOzFmcbydWI4FOaV6MBf3oWDKanMpvCju94" />
    
    <style type="text/css">
      html {
        width: 100%;
        height: 100%;
        background: #111;
      }

      body {
        margin: 0px;
        background-color: #000;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative; /* Added to position logo correctly */
      }

      body > .plyr {
        width: 100%;
        max-height: 100%;
        aspect-ratio: 16/9;
      }

      video {
        aspect-ratio: 16/9;
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: none; /* Hide video initially */
      }

      /* Thumbnail styling */
      .thumbnail {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .thumbnail img {
        max-width: 100%;
        max-height: 100%;
        object-fit: cover;
      }

      @keyframes plyr__time-skip {
        40% {
          opacity: 1;
        }

        100% {
          opacity: 0;
        }
      }

      .plyr__time-skip {
        position: absolute;
        top: 0;
        bottom: 0;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        width: 40%;
        opacity: 0;
        pointer-events: none;
        text-align: center;
      }

      .plyr__time-skip.is-left {
        left: 0;
        background: linear-gradient(
          90deg,
          rgba(0, 0, 0, 0.5) 0%,
          transparent 100%
        );
      }

      .plyr__time-skip.is-right {
        right: 0;
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(0, 0, 0, 0.5) 100%
        );
      }

      .plyr__time-skip.is-animated {
        animation: plyr__time-skip ease 1s forwards;
      }

      :root {
        --plyr-color-main: #00ff8c;
      }

      /* Logo Animation */
      @keyframes glitch {
        0% {
          opacity: 1;
          transform: scale(1);
        }
        25% {
          opacity: 0.8;
          transform: scale(1.05);
        }
        50% {
          opacity: 0.6;
          transform: scale(1.1);
        }
        75% {
          opacity: 0.8;
          transform: scale(1.05);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }

      .logo {
        width: 60px; /* Adjusted size */
        height: auto;
        animation: glitch 1.5s infinite; /* Continuous glitch animation */
      }

      /* Keep logo visible in fullscreen */
      .plyr--full-ui .logo {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 20;
      }
    </style>

    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.jsdelivr.net/npm/plyr@3/dist/plyr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js"></script>
    <script src="https://unpkg.com/plyr@3"></script>

  </head>

  <body>
    <video controls crossorigin playsinline></video>

    <!-- Thumbnail -->
    <div class="thumbnail" id="thumbnail">
      <img id="thumbnailImg" src="" alt="Thumbnail" />
    </div>

    <!-- Logo -->
    <a href="https://ani.mom/" target="_blank" class="logo-container">
        <img src="https://ani.mom/logo.png" alt="Logo" class="logo" />
    </a>

    <script>
      params = new URLSearchParams(location.search);
      const source = params.get("url");
      const id = params.get("episode_id");

      // Fetch the thumbnail image using AniList API
      async function fetchThumbnail(animeId) {
        const response = await fetch(`https://graphql.anilist.co`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            query: `
              query ($id: Int) {
                Media(id: $id) {
                  id
                  title {
                    romaji
                    english
                  }
                  coverImage {
                    extraLarge
                  }
                }
              }`,
            variables: {
              id: animeId,
            },
          }),
        });

        const data = await response.json();
        const thumbnailUrl = data.data.Media?.coverImage?.extraLarge; // Safely access the thumbnail

        return thumbnailUrl || "https://i.ibb.co/89WDbyr/uwp4520478.jpg"; // Return default image if not found
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const video = document.querySelector("video");
        const thumbnailImg = document.getElementById("thumbnailImg");

        // Fetch and set thumbnail image
        const thumbnailUrl = await fetchThumbnail(parseInt(id));
        thumbnailImg.src = thumbnailUrl;

        // Set video poster image
        video.setAttribute("data-poster", thumbnailUrl);

        // Show the thumbnail initially
        const thumbnail = document.getElementById("thumbnail");
        thumbnail.style.display = "flex";

        // Set up video event listeners
        video.addEventListener('play', () => {
          thumbnail.style.display = "none"; // Hide thumbnail when video plays
          video.style.display = "block"; // Show the video
        });

        const defaultOptions = {
          keyboard: {
            focused: true,
            global: true
          },
          controls: [
            "play-large",
            "play",
            "progress",
            "duration",
            "settings",
            "fullscreen"
          ],
          settings: ["quality", "speed"],
          tooltips: {
            controls: true,
            seek: true
          },
          displayDuration: true,
          fullscreen: {
            enabled: true,
            fallback: true,
            iosNative: true
          },
          mediaMetadata: {
            title: id,
            artist: "AnimeEo",
            album: "AnimeEo"
          }
        };

        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(source);
          hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
            const availableQualities = hls.levels.map((l) => l.height);

            defaultOptions.quality = {
              default: availableQualities[0],
              options: availableQualities,
              forced: true,
              onChange: (e) => updateQuality(e)
            };
            const player = new Plyr(video, defaultOptions);
            configPlayer(player);
          });
          hls.attachMedia(video);
          window.hls = hls;
        } else {
          const player = new Plyr(video, defaultOptions);
          configPlayer(player);
        }

        function updateQuality(newQuality) {
          window.hls.levels.forEach((level, levelIndex) => {
            if (level.height === newQuality) {
              window.hls.currentLevel = levelIndex;
            }
          });
        }
        function configPlayer(player) {
          player.on("ready", () => {
            const root = video.closest(".plyr--video");

            player.eventListeners.forEach(function (eventListener) {
              if (eventListener.type === "dblclick") {
                eventListener.element.removeEventListener(
                  eventListener.type,
                  eventListener.callback,
                  eventListener.options
                );
              }
            });
            root.addEventListener("dblclick", function (event) {
              event.preventDefault();
              player.fullscreen.toggle();
            });
          });
        }
      });
    </script>
  </body>
</html>
